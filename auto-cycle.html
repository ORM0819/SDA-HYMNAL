<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="manifest.json">
    <title>SDA Hymnal - Auto Cycle</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Auto Cycle Mode</h1>
    <script>
        function autoCycleSongs() {
            const referrer = document.referrer;
            let cycleMode = 'image'; // Default to image mode

            if (referrer.includes('lyrics.html') || referrer.includes('start-cycle-lyrics.html')) {
                cycleMode = 'lyrics';
            }

            const storageKey = cycleMode === 'lyrics' ? 'currentIndexLyrics' : 'currentIndex';
            const language = localStorage.getItem('languageValue') || 'english';

            // Get the songs URL based on language
            const englishSongsUrl = '/SDA-HYMNAL/songs.json';
            const spanishSongsUrl = '/SDA-HYMNAL/songs_es.json';

            // Fetch both English and Spanish songs
            Promise.all([
                fetch(englishSongsUrl).then(response => response.json()),
                fetch(spanishSongsUrl).then(response => response.json())
            ]).then(([englishSongs, spanishSongs]) => {
                const allSongs = englishSongs.concat(spanishSongs);
                let currentIndex = parseInt(localStorage.getItem(storageKey)) || 0;

                if (currentIndex >= allSongs.length) {
                    // Reset index and redirect to index.html when the end of the list is reached
                    localStorage.setItem(storageKey, 0);
                    window.location.href = '/SDA-HYMNAL/index.html';
                    return;
                }

                const song = allSongs[currentIndex];
                localStorage.setItem(storageKey, currentIndex + 1);

                const title = encodeURIComponent(song.title);
                const number = encodeURIComponent(song.number);
                const contentOrImage = cycleMode === 'lyrics'
                    ? encodeURIComponent(song.content)
                    : encodeURIComponent(`src/Hymnal.XF/Resources/Assets/MusicSheets/${song.image}`);

                const redirectUrl = cycleMode === 'lyrics'
                    ? `/SDA-HYMNAL/lyrics.html?content=${contentOrImage}&title=${title}&number=${number}`
                    : `/SDA-HYMNAL/image.html?image=${contentOrImage}&title=${title}&number=${number}`;

                console.log(`Redirecting to: ${redirectUrl}`);
                window.location.href = redirectUrl;
            }).catch(error => {
                console.error('Error loading songs:', error);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const referrer = document.referrer;

            // Reset index if coming from a non-cycling page
            if (!referrer.includes('image.html') && !referrer.includes('lyrics.html')) {
                localStorage.setItem('currentIndex', 0);
                localStorage.setItem('currentIndexLyrics', 0);
            }

            autoCycleSongs();
        });
    </script>
</body>
</html>
